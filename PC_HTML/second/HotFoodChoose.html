<!doctype html>
<html>
<header class="mui-bar mui-bar-nav">
  <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
  <h1 class="mui-title">人气菜品评选</h1>
</header>

<head>
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <meta charset="UTF-8">
  <title></title>
  <!-- <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" /> -->
  <link href="../../css/mui.min.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="../../css/boostrap/bootstrap.css" />
  <script src="../../js/jquery-3.3.1.js" type="text/javascript" charset="utf-8"></script>
  <script src="../../js/bootstrap.js" type="text/javascript" charset="utf-8"></script>
  <style type="text/css">
    .mui-input-group .mui-input-row {
      height: 80px;
    }

    .white-block {
      background: white;
      border-radius: 10px;
      height: 220px;
      width: 140px;
      display: block;
      margin: 0 auto;
      box-shadow: 5px 5px 5px rgb(0, 0, 0, .4);
    }

    .inside-block {
      padding: 10px 10px 10px 10px;
      text-align: center;
    }

    .pic-style {
      height: 90px;
      width: 120px;
      border-radius: 20px;
    }

    .col-xs-6 {
      margin-bottom: 20px;
    }

    .row-item {
      margin-bottom: 20px;
    }

    body {
      background: linear-gradient(to right, #67c8b8, #3e87c8);
    }
  </style>
</head>

<body>
  <script src="../../js/mui.min.js"></script>
  <div class="row" style="margin-top: 70px;margin-bottom:25px;color: white;text-align: center;">
    <h3 style="display: inline-block; " id="title-text">早餐</h3>

  </div>

  <div class="row row-item" id="menuBox-Bf">

  </div>
  <div class="row" style="margin-top: 10px;margin-bottom:25px;color: white;text-align: center;">
    <h3 style="display: inline-block; " id="title-text">午餐和晚餐</h3>

  </div>
  <div class="row row-item" id="menuBox-lunch">

  </div>
  <div class="row row-item" id="menuBox-supper">

  </div>
  <div class="row">
    <button type="button" class="btn btn-default" onclick="refresh()"
      style="display: block;margin: 0 auto;width: 200px;height: 40px;  margin-bottom: 30px;">重置投票</button>
    <button type="button" class="btn btn-default" onclick="VoteAll()"
      style="display: block;margin: 0 auto;width: 200px;height: 40px;  margin-bottom: 30px;">投票</button>
  </div>

</body>
<script type="text/javascript">
  mui.init()
</script>
<script type="text/javascript">
  function refresh() {
    history.go(0);
  }

  //定义写log方法/////////////////////////////////////////
  var logApiUrl = localStorage.getItem('logApiUrl')
  var JWTtoken = localStorage.getItem('JWTtoken')
  var appCode = localStorage.getItem('appCode')
  var source = localStorage.getItem('source')



  //定义写log方法
  function writeLogFun(dataInput) {
    var pararms = {
      policeId: dataInput.policeId,
      userName: dataInput.userName,
      cardNo: dataInput.cardNo,
      orgName: dataInput.orgName,
      orgCode: dataInput.orgCode,
      requestId: dataInput.requestId,
      sessionId: dataInput.sessionId,
      terminalIp: '20.97.10.' + Math.ceil(Math.random() * 100),
      logType: dataInput.logType,
      module: dataInput.module,
      params: dataInput.params + '',
      formatParam: dataInput.formatParam + '',
      url: dataInput.url,
      uri: dataInput.uri,
      content: dataInput.content,
      response: dataInput.response,
      responseType: dataInput.responseType,
      imei: dataInput.imei,
      business: dataInput.business,
      mac: dataInput.mac,
      responseTime: dataInput.responseTime + '',
      result: dataInput.result,
      errorCode: dataInput.errorCode,
      errorLog: dataInput.errorLog,
      sourceIp: dataInput.sourceIp,
      sourcePort: dataInput.sourcePort,
      destIp: dataInput.destIp,
      destPort: dataInput.destPort,
      appCode: appCode,
      source: source,
      recordTime: dataInput.recordTime + '',
      isSystemLog: dataInput.isSystemLog
    }

    $.ajax({
      url: logApiUrl + "/logs/operateLog",
      contentType: 'application/json',
      data: JSON.stringify(pararms),
      type: 'post',
      async: false,
      crossDomain: true,
      headers: {
        'LinkJWTAuth': 'Bearer ' + JWTtoken
      },
      success: function (result) {
        //响应时间
        // var timeSpan = (new Date()).getTime() - startTime
        // console.log('timeSpan', timeSpan, startTime, result)
      }
    });
  }
  ///////////////////////////////////////////////////////////

  var replace_url = localStorage.getItem("replace_url");
  var post_url_all_header = localStorage.getItem("url_header");
  var urlGet = post_url_all_header + "/Interface/Common/GetCookbookSetInDateByDate.ashx";

  //记录时间
  var startTime = (new Date()).getTime()
  var timeSpan = null;

  $.ajax({
    url: urlGet,
    data: {
      'Datetime': getNowFormatDate()
    },
    dataType: 'json',
    type: 'get',
    async: false,
    crossDomain: true, //【这个很重要，一定要加】
    success: function (result) {
      //响应时间
      timeSpan = (new Date()).getTime() - startTime
      console.log(result);
      result.breakfasts.forEach(
        function (currentValue, currentIndex, currentArray) {
          console.log(currentValue.CookbookEnum);
          var nhBool = currentValue.Name.indexOf("家属") != -1;
          console.log(nhBool);
          if (!nhBool) {

            switch (currentValue.CookbookEnum) {
              case 'Breakfast':
                var appendItem =
                  '<div class="col-xs-6"><div class="white-block"><div class="inside-block"><div class="row"><img src="' +
                  currentValue.Icon.replace(replace_url, '20.96.28.147/zhct') + '" class="pic-style" /></div><div class="row"><h4>' +
                  currentValue.Name +
                  '</h4></div><div class="row"><p>投票:' + currentValue.Votes + '票</p></div><div class="row"><button class="bf" id="' + currentValue.Id +
                  '" value="' + 'true' +
                  '" class="btn btn-default" >投票</button></div></div></div></div>';
                $("#menuBox-Bf").append(appendItem);
                break;
              case 'Lunch':
                var appendItem =
                  '<div class="col-xs-6"><div class="white-block"><div class="inside-block"><div class="row"><img src="' +
                  currentValue.Icon.replace(replace_url, '20.96.28.147/zhct') + '" class="pic-style" /></div><div class="row"><h4>' +
                  currentValue.Name +
                  '</h4></div><div class="row"><p>投票:' + currentValue.Votes + '票</p></div><div class="row"><button class="lunch" id="' +
                  currentValue.Id +
                  '" value="' + 'true' +
                  '" class="btn btn-default" >投票</button></div></div></div></div>';
                $("#menuBox-lunch").append(appendItem);
                break;
              case 'Supper':
                var appendItem =
                  '<div class="col-xs-6"><div class="white-block"><div class="inside-block"><div class="row"><img src="' +
                  currentValue.Icon.replace(replace_url, '20.96.28.147/zhct') + '" class="pic-style" /></div><div class="row"><h4>' +
                  currentValue.Name +
                  '</h4></div><div class="row"><p>投票:' + currentValue.Votes + '票</p></div><div class="row"><button class="supper" id="' +
                  currentValue.Id +
                  '" value="' + 'true' +
                  '" class="btn btn-default" >投票</button></div></div></div></div>';
                $("#menuBox-supper").append(appendItem);
                break;
            }
          }
        }
      );
      result.LunchAndSuppers.forEach(
        function (currentValue, currentIndex, currentArray) {
          console.log(currentValue.CookbookEnum);
          var nhBool = currentValue.Name.indexOf("家属") != -1;
          if (!nhBool) {
            switch (currentValue.CookbookEnum) {
              case 'Breakfast':
                var appendItem =
                  '<div class="col-xs-6"><div class="white-block"><div class="inside-block"><div class="row"><img src="' +
                  currentValue.Icon.replace(replace_url, '20.96.28.147/zhct') + '" class="pic-style" /></div><div class="row"><h4>' +
                  currentValue.Name +
                  '</h4></div><div class="row"><p>投票:' + currentValue.Votes + '票</p></div><div class="row"><button class="bf" id="' + currentValue.Id +
                  '" value="' + 'true' +
                  '" class="btn btn-default" >投票</button></div></div></div></div>';
                $("#menuBox-Bf").append(appendItem);
                break;
              case 'Lunch':
                var appendItem =
                  '<div class="col-xs-6"><div class="white-block"><div class="inside-block"><div class="row"><img src="' +
                  currentValue.Icon.replace(replace_url, '20.96.28.147/zhct') + '" class="pic-style" /></div><div class="row"><h4>' +
                  currentValue.Name +
                  '</h4></div><div class="row"><p>投票:' + currentValue.Votes + '票</p></div><div class="row"><button class="lunch" id="' +
                  currentValue.Id +
                  '" value="' + 'true' +
                  '" class="btn btn-default" >投票</button></div></div></div></div>';
                $("#menuBox-lunch").append(appendItem);
                break;
              case 'Supper':
                var appendItem =
                  '<div class="col-xs-6"><div class="white-block"><div class="inside-block"><div class="row"><img src="' +
                  currentValue.Icon.replace(replace_url, '20.96.28.147/zhct') + '" class="pic-style" /></div><div class="row"><h4>' +
                  currentValue.Name +
                  '</h4></div><div class="row"><p>投票:' + currentValue.Votes + '票</p></div><div class="row"><button class="supper" id="' +
                  currentValue.Id +
                  '" value="' + 'true' +
                  '" class="btn btn-default" >投票</button></div></div></div></div>';
                $("#menuBox-lunch").append(appendItem);
                break;
            }
          }
        }
      );
      /////////////加日志//////////////////
      ///////日志代码

      //获取警员ID
      var loginId = localStorage.getItem("PCNum");
      var pcName = localStorage.getItem("Name");
      var orgName = localStorage.getItem("WorkUnit");
      var idtifiNum = localStorage.getItem("personImformationId");
      var dataInput = {
        policeId: loginId,
        userName: pcName,
        cardNo: idtifiNum,
        orgName: orgName,
        orgCode: orgName,
        requestId: 'w223dc10-905e-4fa7-8680-465b2549' + Math.ceil(Math.random() * 1000),
        sessionId: '0PO98968A9BE3F434A177933407B' + Math.ceil(Math.random() * 1000),
        terminalIp: '20.97.10.' + Math.ceil(Math.random() * 100),
        logType: '1',
        module: '每日菜品投票',
        params: '{"Datetime":"' + getNowFormatDate() + '"}',
        formatParam: '{"日期":"' + getNowFormatDate() + '"}',
        url: post_url_all_header,
        uri: '/Interface/Common/GetCookbookSetInDateByDate.ashx',
        content: '',
        response: JSON.stringify(result),
        responseType: '1',
        responseTime: timeSpan,
        imei: '',
        business: '已办公文',
        mac: '',
        result: '成功',
        errorCode: '',
        errorLog: '',
        sourceIp: '20.97.10.' + Math.ceil(Math.random() * 100),
        sourcePort: '7878',
        destIp: '20.96.28.147',
        destPort: '7029',
        appCode: 'com.bingo.zhjw',
        source: '505',
        recordTime: (new Date()).getTime(),
        isSystemLog: '0',
      }
      ////////////////////////////
      writeLogFun(dataInput)
    }
  });
  var bfList = [];
  var lunchList = [];
  $("button").click(function () {
    var val = $(this).val();
    var itemId = $(this).attr('id');
    var menuType = $(this).attr('class');
    if (val == 'true') {
      switch (menuType) {
        case 'bf':
          if (bfList.length < 99) {
            bfList.push(itemId);
          }
          else {
            mui.alert("不可选择超过两个早餐菜品")
            return;
          }
          break;
        case 'lunch':
          if (lunchList.length < 99) {
            lunchList.push(itemId);
          }
          else {
            mui.alert("不可选择超过三个午餐和晚餐菜品")
            return;
          }
          break;
        case 'supper':
          if (lunchList.length < 99) {
            lunchList.push(itemId);
          }
          else {
            mui.alert("不可选择超过三个午餐和晚餐菜品")
            return;
          }
          break;
      }
    }
    else {
      if (menuType == 'bf') {
        bfList.pop(itemId);
      }
      else {
        lunchList.pop(itemId);
      }

    }

    if ($(this).val() == 'true') {
      $(this).css("background", "#61ff61");
      $(this).val(false);
    } else {
      $(this).css("background", "white");
      $(this).val(true);
    }

  })



  //投票！！
  function VoteAll() {

    for (var i in bfList) {
      lunchList.push(bfList[i]);
    }
    var bigList = "";
    lunchList.forEach(function (currentValue, currentIndex, currentArray) {
      bigList = bigList + currentValue + ',';
    })
    bigList = bigList.substr(0, bigList.length - 1);
    var newtime = getNowFormatDate2();


    var sendData = JSON.stringify({
      "DateTime": newtime,
      "CookbookIds": bigList,
      "StaffId": localStorage.getItem('personId'),//localStorage.getItem('personId')
      "StaffType": localStorage.getItem('PcWorkerBool'), //Worker  localStorage.getItem('PcWorkerBool')
      "Suggest": "1"
    });
    //记录时间
    var startTime = (new Date()).getTime()
    var timeSpan = null;
    $.ajax({
      url: post_url_all_header + '/Interface/Common/CoookbookVote.ashx',
      data: sendData,
      dataType: 'json',
      type: 'post',
      async: false,
      crossDomain: true, //【这个很重要，一定要加】
      success: function (result) {
        //响应时间
        timeSpan = (new Date()).getTime() - startTime
        alert(result.Msg);
        window.location.href = "../Pc_menuPage.html";
        ////////////
        /////////////加日志//////////////////
        ///////日志代码

        //获取警员ID
        var loginId = localStorage.getItem("PCNum");
        var pcName = localStorage.getItem("Name");
        var orgName = localStorage.getItem("WorkUnit");
        var idtifiNum = localStorage.getItem("personImformationId");
        var dataInput = {
          policeId: loginId,
          userName: pcName,
          cardNo: idtifiNum,
          orgName: orgName,
          orgCode: orgName,
          requestId: 'w223dc10-905e-4fa7-8680-465b2549' + Math.ceil(Math.random() * 1000),
          sessionId: '0PO98968A9BE3F434A177933407B' + Math.ceil(Math.random() * 1000),
          terminalIp: '',
          logType: '2',
          module: '投票提交',
          params: sendData,
          formatParam: sendData,
          url: post_url_all_header,
          uri: '/Interface/Common/CoookbookVote.ashx',
          content: '',
          response: JSON.stringify(result),
          responseType: '1',
          responseTime: timeSpan,
          imei: '',
          business: '已办公文',
          mac: '',
          result: '成功',
          errorCode: '',
          errorLog: '',
          sourceIp: '20.97.10.' + Math.ceil(Math.random() * 100),
          sourcePort: '7878',
          destIp: '20.96.28.147',
          destPort: '7029',
          appCode: 'com.bingo.zhjw',
          source: '505',
          recordTime: (new Date()).getTime(),
          isSystemLog: '0',
        }
        ////////////////////////////
        writeLogFun(dataInput)
      }
    });
  }
  //时间获取
  function getNowFormatDate() {
    var date = new Date();
    var seperator1 = "-";
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
      month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
      strDate = "0" + strDate;
    }
    var currentdate = year + seperator1 + month + seperator1 + strDate;
    return currentdate;
  }
  // /时间获取2
  function getNowFormatDate2() {
    var date = new Date();
    var seperator1 = "-";
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
      month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
      strDate = "0" + strDate;
    }
    var currentdate = year + seperator1 + month + seperator1 + strDate + ' ' + date.getHours() + ':' + date.getMinutes() +
      ':' + date.getSeconds() + '.' + date.getMilliseconds();
    return currentdate;
  }
</script>

</html>